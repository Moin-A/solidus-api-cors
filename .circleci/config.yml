version: 2.1

jobs:
  test-ssh:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      
      # Decrypt SSH key from CircleCI environment variables
      - run:
          name: Decrypt SSH key
          command: |
            mkdir -p ~/.ssh
            echo "$ENCRYPTED_SSH_KEY" | base64 -d | \
              openssl enc -aes-256-cbc -d -pbkdf2 -k "$ENCRYPTION_KEY" \
              > ~/.ssh/kamal-deploy-key.pem
            chmod 600 ~/.ssh/kamal-deploy-key.pem
      
      # Test SSH connection
      - run:
          name: Test SSH connection to EC2
          command: |
            ssh-keyscan -H $EC2_IP >> ~/.ssh/known_hosts
            ssh -i ~/.ssh/kamal-deploy-key.pem ec2-user@$EC2_IP "hostname && whoami"

  deploy:
    docker:
      - image: cimg/ruby:3.1
    steps:
      # Step 1: Checkout code (this brings config/deploy.yml into CircleCI)
      - checkout
      
      # Step 1.5: Setup Docker for building images
      # Using a specific version known to work well with BuildKit
      - setup_remote_docker:
          version: 20.10.24
          docker_layer_caching: false
      
      # Step 2: Install Kamal gem
      - run:
          name: Install Kamal
          command: |
            gem install kamal -v 1.5.0
      
      # Step 3: Decrypt SSH key
      - run:
          name: Decrypt SSH key
          command: |
            mkdir -p ~/.ssh
            echo "$ENCRYPTED_SSH_KEY" | base64 -d | \
              openssl enc -aes-256-cbc -d -pbkdf2 -k "$ENCRYPTION_KEY" \
              > ~/.ssh/kamal-deploy-key.pem
            chmod 600 ~/.ssh/kamal-deploy-key.pem
      
      # Step 4: Setup SSH config for Kamal
      - run:
          name: Setup SSH config
          command: |
            printf "Host $EC2_IP\n  IdentityFile ~/.ssh/kamal-deploy-key.pem\n  StrictHostKeyChecking no\n  User ec2-user\n" >> ~/.ssh/config
            chmod 600 ~/.ssh/config
      
      # Step 5: Verify config/deploy.yml exists (for debugging)
      - run:
          name: Verify deploy config
          command: |
            ls -la config/deploy.yml
            echo "✅ config/deploy.yml found!"
      
      # Step 6: Build and Push Docker Image
      - run:
          name: Build and Push Docker Image
          command: |
            # 1. Login to Docker Hub
            echo "$KAMAL_REGISTRY_PASSWORD" | docker login -u moindev --password-stdin
            
            # 2. Get the git version hash
            KAMAL_VERSION=$(git rev-parse HEAD)
            echo "Building version: $KAMAL_VERSION"
            
            # 3. Build image manually
            # CRITICAL: Add 'service' label for Kamal
            docker build -t moindev/solidus-api-cors:$KAMAL_VERSION -t moindev/solidus-api-cors:latest --label service="solidus-api-cors" .
            
            # 4. Push images
            docker push moindev/solidus-api-cors:$KAMAL_VERSION
            docker push moindev/solidus-api-cors:latest

      # Step 7: Prepare EC2 (Stop conflicts)
      - run:
          name: Prepare EC2
          command: |
             ssh -i ~/.ssh/kamal-deploy-key.pem -o ConnectTimeout=10 ec2-user@$EC2_IP "sudo systemctl stop httpd || true && sudo systemctl stop nginx || true"

      # Step 8: Boot Accessories (Database & Redis)
      - run:
          name: Boot Database and Redis
          command: |
            echo "Booting database accessory..."
            kamal accessory boot db || echo "Database might already be running"
            
            echo "Booting redis accessory..."
            kamal accessory boot redis || echo "Redis might already be running"

            echo "Booting redis accessory..."
            kamal accessory boot storefront || echo "Storefront might already be running"

      # Step 9: Deploy App with Kamal
      - run:
          name: Run Kamal Deploy
          command: |
            # Debug: Check if variables exist (do not print values)
            [ -z "$RAILS_MASTER_KEY" ] && echo "❌ RAILS_MASTER_KEY is missing!" || echo "✅ RAILS_MASTER_KEY is found"
            [ -z "$POSTGRES_PASSWORD" ] && echo "❌ POSTGRES_PASSWORD is missing!" || echo "✅ POSTGRES_PASSWORD is found"
            [ -z "$SECRET_KEY_BASE" ] && echo "❌ SECRET_KEY_BASE is missing!" || echo "✅ SECRET_KEY_BASE is found"
            
            KAMAL_VERSION=$(git rev-parse HEAD)
            
            # Explicitly push environment variables
            echo "Pushing environment variables..."
            kamal env push
            
            # Debug: Verify env file exists on remote
            echo "Verifying remote env file..."
            ssh -i ~/.ssh/kamal-deploy-key.pem ec2-user@$EC2_IP "ls -la .kamal/env/roles/" || echo "❌ Remote env file missing!"
            
            # Use --skip-push since we pushed manually
            kamal deploy --skip-push --version $KAMAL_VERSION

workflows:
  test-ssh-workflow:
    jobs:
      - test-ssh
  
  deploy-workflow:
    jobs:
      - deploy:
          filters:
            branches:
              only: main

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# REQUIRED ENVIRONMENT VARIABLES (Add in CircleCI Project Settings):
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#
# 1. ENCRYPTION_KEY
#    - The key generated with: openssl rand -base64 32
#    - Example: sm43jmDDDcq7iZ8ht1Clkds2tmh09WgdzuXlXwwnKIM=
#
# 2. ENCRYPTED_SSH_KEY
#    - The base64 encoded encrypted PEM file
#    - Generate with:
#      openssl enc -aes-256-cbc -salt -pbkdf2 \
#        -in ~/.ssh/kamal-deploy-key.pem \
#        -out encrypted-key.enc \
#        -k "$ENCRYPTION_KEY"
#      base64 -i encrypted-key.enc
#    - Paste the entire base64 output
#
# 3. EC2_IP
#    - Your EC2 instance public IP address
#    - Example: 13.53.125.253
#
# 4. POSTGRES_PASSWORD
#    - Strong password for PostgreSQL database
#    - Generate with: openssl rand -base64 32
#    - Example: xK9mP2qL8vN4rT6wY1zA3bC5dE7fG9hI0jK2lM4nO6pQ8rS0tU2vW4xY6zA8b
#
# 5. RAILS_MASTER_KEY
#    - Your Rails master key from config/master.key
#    - Copy the entire contents of config/master.key
#
# 6. SECRET_KEY_BASE (NEW)
#    - Generate with: openssl rand -hex 64
#    - Example: 83d2... (long hex string)
#    - This fixes "ArgumentError: key must be 16 bytes" by bypassing credential decryption
#
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# TO ADD ENVIRONMENT VARIABLES:
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#
# 1. Go to: https://app.circleci.com/settings/project/github/YOUR_USERNAME/solidus-api-cors/environment-variables
# 2. Click "Add Environment Variable" 
# 3. Add each variable listed above
#
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
